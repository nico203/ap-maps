/*! ap-maps 2018-02-05 */

angular.module("ap-maps",["adminPanel"]),angular.module("ap-maps").directive("apMapPoint",["mapService","pointNormalizer","$rootScope","$timeout",function(n,e,l,t){return{restrict:"AE",require:"?ngModel",scope:{name:"@"},link:function(t,o,a,i){var r=!angular.isUndefined(a.readonly),p=this;function u(n){var l=e.normalize(n);p.point=l,null!==p.map&&(p.map.panTo(l),c(l))}function c(n){null!==p.marker&&(p.marker.remove(),p.marker=null),p.marker=L.marker([n.lat,n.lng]),p.marker.addTo(p.map)}function m(n){if(null!==p.map){var o=n.latlng;c(o);var a=e.denormalize(o);l.$broadcast("ap-map:pointpicker",t.name,a),null!==i&&i.$setViewValue(a)}}p.elemMap=o.find(".map"),t.height=n.height,p.map=null,p.marker=null,p.point=null,p.initPromise=n.init(p.elemMap[0]).then(function(n){p.map=n,r||p.map.on("click",m),null!==p.point&&(p.map.panTo(p.point),c(p.point))}),t.$on("apMap:showOnMapPoint",function(n,e,l){t.name===e&&null!==l&&u(l)}),null!==i&&t.$watch(function(){return i.$modelValue},function(n){n&&angular.isObject(n)&&u(n)});var s=t.$on("$destroy",function(){null!==p.map&&p.map.off("click",m),s()})},templateUrl:"directives/mapPoint/mapPoint.template.html"}}]),angular.module("ap-maps").directive("apMapPolygon",["mapService","polygonNormalizer","$rootScope","$timeout",function(n,e,l,t){return{restrict:"AE",require:"?ngModel",scope:{name:"@"},link:function(o,a,i,r){var p=this;function u(n){if(null!==p.map){var e=n.latlng,l=L.marker(e);l.addTo(p.map),l.on("click",c),p.markers.push(l),null===p.polyline?p.polyline=L.polyline([e],{color:"red"}).addTo(p.map):p.polyline.addLatLng(e)}}function c(n){for(var e=p.polyline.getLatLngs(),l=0;l<e.length;l++)if(e[l].equals(n.latlng)){e.splice(l,1);break}this.remove(),p.polyline.remove(),p.polyline=L.polyline(e,{color:"red"}).addTo(map)}function m(){for(var n=0;n<p.markers.length;n++)p.markers[n].off("click",c),p.markers[n].remove();p.markers=[],null!==p.polyline&&(p.polyline.remove(),p.polyline=null),null!==p.polygon&&(p.polygon.remove(),p.polygon=null)}function s(n){t(function(){var l=e.normalize(n);m(),p.polygon=L.polygon(l[0].latLngs,{color:"red"}).addTo(p.map)})}a.addClass("ap-map-polygon"),p.elemMap=a.find(".map"),o.height=n.height,p.map=null,p.markers=[],p.polyline=null,p.polygon=null,n.init(p.elemMap[0]).then(function(n){p.map=n,p.map.on("click",u)}),o.finish=function(){if(null!==p.polyline){var n=p.polyline.getLatLngs();m(),p.polygon=L.polygon(n,{color:"red"}).addTo(p.map);var t=[];t.push(n);var a=e.denormalize(t);l.$broadcast("ap-map:polygonpicker",o.name,a),null!==r&&r.$setViewValue(a)}},o.clear=m;var d=o.$on("apMap:showOnMapPolygon",function(n,e,l){o.name===e&&null!==l&&s(l)});null!==r&&o.$watch(function(){return r.$modelValue},function(n){n&&angular.isObject(n)&&s(n)});var g=o.$on("$destroy",function(){null!==p.map&&p.map.off("click",u),d(),g()})},templateUrl:"directives/mapPolygon/mapPolygon.template.html"}}]),angular.module("ap-maps").directive("apMapPolyline",["mapService","$rootScope",function(n,e){return{restrict:"AE",scope:{name:"@"},link:function(l,t,o){var a=t.find(".map");l.height=n.height;var i=null,r=[],p=null;function u(n){if(null!==i){var e=n.latlng,l=L.marker(e);l.addTo(i),l.on("click",c),r.push(l),null===p?p=L.polyline([e],{color:"red"}).addTo(i):p.addLatLng(e)}}function c(n){for(var e=p.getLatLngs(),l=0;l<e.length;l++)if(e[l].equals(n.latlng)){e.splice(l,1);break}this.remove(),p.remove(),p=L.polyline(e,{color:"red"}).addTo(i)}function m(){console.log(r);for(var n=0;n<r.length;n++)r[n].off("click",c),r[n].remove();r=[],null!==p&&(p.remove(),p=null)}n.init(a[0]).then(function(n){(i=n).on("click",u)}),l.finish=function(){if(null!==p){var n=p.getLatLngs();m(),p=L.polyline(n,{color:"red"}).addTo(i),e.$broadcast("ap-map:polylinepicker",l.name,n)}},l.clear=m;var s=l.$on("apMap:showOnMapPolyline",function(n,e,t){l.name===e&&null!==t&&(m(),p=L.polyline(t.latLngs,{color:"red"}).addTo(i))}),d=l.$on("$destroy",function(){null!==i&&i.off("click",u),s(),d()})},templateUrl:"directives/mapPolyline/mapPolyline.template.html"}}]),angular.module("ap-maps").directive("pointPicker",["$rootScope","$timeout",function(n,e){return{require:"ngModel",restrict:"AE",scope:{name:"@"},link:function(l,t,o,a){var i=this;l.model={latitud:null,longitud:null},i.point=null;var r=l.$on("ap-map:pointpicker",function(n,e,t){l.name===e&&a.$setViewValue(t)});l.clickBtn=function(){o.view?(n.$broadcast("apBox:show",o.view),e(function(){n.$broadcast("apMap:showOnMapPoint",l.name,i.point)})):n.$broadcast("apMap:showOnMapPoint",l.name,i.point)},l.$watch(function(){return a.$modelValue},function(n){n&&(i.point=n,l.model.latitud=n.y,l.model.longitud=n.x)});var p=l.$on("$destroy",function(){r(),p()})},templateUrl:"directives/pointPicker/pointPicker.template.html"}}]),angular.module("ap-maps").directive("polygonPicker",["$rootScope","$timeout",function(n,e){return{require:"ngModel",restrict:"AE",scope:{name:"@"},link:function(l,t,o,a){var i=this;i.polygon=null;var r=l.$on("ap-map:polygonpicker",function(n,e,t){l.name===e&&a.$setViewValue(t)});l.clickBtn=function(){o.view?(n.$broadcast("apBox:show",o.view),e(function(){n.$broadcast("apMap:showOnMapPolygon",l.name,i.polygon)})):n.$broadcast("apMap:showOnMapPolygon",l.name,i.polygon)},l.$watch(function(){return a.$modelValue},function(n){n&&(i.polygon=n)});var p=l.$on("$destroy",function(){r(),p()})},templateUrl:"directives/polygonPicker/polygonPicker.template.html"}}]),angular.module("ap-maps").directive("polylinePicker",["linestringNormalizer","$rootScope",function(n,e){return{require:"ngModel",restrict:"AE",scope:{name:"@"},link:function(l,t,o,a){var i=null,r=l.$on("ap-map:polylinepicker",function(e,t,o){if(l.name===t){var i=n.denormalize(o);a.$setViewValue(i)}});l.clickBtn=function(){o.view&&e.$broadcast("apBox:show",o.view),e.$broadcast("apMap:showOnMapPolyline",l.name,i)},l.$watch(function(){return a.$modelValue},function(e){e&&(i=n.normalize(e))});var p=l.$on("$destroy",function(){r(),p()})},templateUrl:"directives/polylinePicker/polylinePicker.template.html"}}]),angular.module("ap-maps").provider("MapsConfig",function(){var n=435,e=[-31.649913,-60.712328],l=13,t="OpenStreetMap.Mapnik";this.setMapHeight=function(e){return n=e,this},this.setCenter=function(n){return e=n,this},this.setZoom=function(n){return l=n,this},this.setTileProvider=function(n){return t=n,this},this.$get=[function(){return{defaultMapHeight:n,defaultCenter:e,defaultZoom:l,defaultTileProvider:t}}]}),angular.module("ap-maps").service("mapService",["MapsConfig","$timeout",function(n,e){return{height:n.defaultMapHeight,init:function(l){return e(function(){var e=L.map(l,{center:n.defaultCenter,zoom:n.defaultZoom},1e3);return L.tileLayer.provider(n.defaultTileProvider).addTo(e),e})}}}]),angular.module("ap-maps").service("linestringNormalizer",["pointNormalizer",function(n){this.normalize=function(e){for(var l=[],t=0;t<e.points.length;t++){var o=e.points[t];l.push(n.normalize(o))}return{latLngs:l,closed:e.closed}},this.denormalize=function(e){for(var l=[],t=0;t<e.length;t++)l.push(n.denormalize(e[t]));return{points:l}}}]),angular.module("ap-maps").service("pointNormalizer",[function(){this.normalize=function(n){return L.latLng(n.y,n.x)},this.denormalize=function(n){return{x:n.lng,y:n.lat}}}]),angular.module("ap-maps").service("polygonNormalizer",["linestringNormalizer",function(n){this.normalize=function(e){for(var l=[],t=0;t<e.rings.length;t++){var o=e.rings[t];l.push(n.normalize(o))}return l},this.denormalize=function(e){for(var l=[],t=0;t<e.length;t++){var o=e[t];console.log("ring "+t,e[t]),o[0].equals(o[o.length-1])||o.push(o[0]);var a=n.denormalize(o);console.log("lineString "+t,a),l.push(a)}return{rings:l}}}]),angular.module("adminPanel").run(["$templateCache",function(n){n.put("directives/mapPoint/mapPoint.template.html","<div class=map ng-style=\"{'height':height}\"></div>"),n.put("directives/mapPolygon/mapPolygon.template.html","<div class=map ng-style=\"{'height':height}\"></div><button type=button class=button ng-click=clear()>Limpiar</button><button type=button class=button ng-click=finish()>Terminar</button>"),n.put("directives/mapPolyline/mapPolyline.template.html","<div class=map ng-style=\"{'height':height}\"></div><button type=button class=button ng-click=clear()>Limpiar</button><button type=button class=button ng-click=finish()>Terminar</button>"),n.put("directives/pointPicker/pointPicker.template.html",'<div class=row><div class="columns small-12 large-6"><label>Latitud <input type=text ng-value=model.latitud readonly></label></div><div class="columns small-12 large-6"><label>Longitud <input type=text ng-value=model.longitud readonly></label></div><div class="columns small-12 large-6"><button type=button class=button ng-click=clickBtn()>Ver Punto en Mapa</button></div></div>'),n.put("directives/polygonPicker/polygonPicker.template.html",'<div class=row><div class="columns small-12 large-6"><button type=button class=button ng-click=clickBtn()>Ver en Mapa</button></div></div>'),n.put("directives/polylinePicker/polylinePicker.template.html",'<div class=row><div class="columns small-12 large-6"><button type=button class=button ng-click=clickBtn()>Ver en Mapa</button></div></div>')}]);