/*! ap-maps 2018-02-09 */

angular.module("ap-maps",["adminPanel"]),angular.module("ap-maps").directive("apMapPoint",["mapService","pointNormalizer","$rootScope","$timeout",function(n,e,o,l){return{restrict:"AE",require:"?ngModel",scope:{name:"@"},link:function(l,t,a,i){var r=!angular.isUndefined(a.readonly),p=this;function u(n){var o=e.normalize(n);p.point=o,null!==p.map&&(p.map.panTo(o),c(o))}function c(n){null!==p.marker&&(p.marker.remove(),p.marker=null),p.marker=L.marker([n.lat,n.lng]),p.marker.addTo(p.map)}function m(n){if(null!==p.map){var t=n.latlng;c(t);var a=e.denormalize(t);o.$broadcast("ap-map:pointpicker",l.name,a),null!==i&&i.$setViewValue(a)}}p.elemMap=t.find(".map"),l.height=n.height,p.map=null,p.marker=null,p.point=null,p.initPromise=n.init(p.elemMap[0]).then(function(n){p.map=n,r||p.map.on("click",m),null!==p.point&&(p.map.panTo(p.point),c(p.point))}),l.$on("apMap:showOnMapPoint",function(n,e,o){l.name===e&&null!==o&&u(o)}),null!==i&&l.$watch(function(){return i.$modelValue},function(n){n&&angular.isObject(n)&&u(n)});var s=l.$on("$destroy",function(){null!==p.map&&p.map.off("click",m),s()})},templateUrl:"directives/mapPoint/mapPoint.template.html"}}]),angular.module("ap-maps").directive("apMapPolygon",["mapService","polygonNormalizer","$rootScope","$timeout",function(n,e,o,l){return{restrict:"AE",require:"?ngModel",scope:{name:"@",fixedPolygons:"=?"},link:function(t,a,i,r){var p=this;function u(n){if(null!==p.map){var e=n.latlng,o=L.marker(e);o.addTo(p.map),o.on("click",c),p.markers.push(o),null===p.polyline?p.polyline=L.polyline([e],{color:"red"}).addTo(p.map):p.polyline.addLatLng(e)}}function c(n){for(var e=p.polyline.getLatLngs(),o=0;o<e.length;o++)if(e[o].equals(n.latlng)){e.splice(o,1);break}this.remove(),p.polyline.remove(),p.polyline=L.polyline(e,{color:"red"}).addTo(p.map)}function m(){for(var n=0;n<p.markers.length;n++)p.markers[n].off("click",c),p.markers[n].remove();p.markers=[],null!==p.polyline&&(p.polyline.remove(),p.polyline=null)}function s(){m(),console.log("self.polygon",p.polygon);for(var n=0;n<p.polygon.length;n++)p.polygon[n].remove();p.polygon=[]}function d(n){l(function(){var o=e.normalize(n);s(),p.polygon=[];for(var l=0;l<o.length;l++)p.polygon.push(L.polygon(o[l].latLngs,{color:"red"}).addTo(p.map))})}a.addClass("ap-map-polygon"),p.elemMap=a.find(".map"),t.height=n.height,p.map=null,p.markers=[],p.polyline=null,p.polygon=[],p.fixedPolygons=[],n.init(p.elemMap[0]).then(function(n){p.map=n,p.map.on("click",u)}),t.finish=function(){if(null!==p.polyline){var n=p.polyline.getLatLngs();m(),null===r&&p.polygon.push(L.polygon(n,{color:"red"}).addTo(p.map));for(var l=[],a=0;a<p.polygon.length;a++)l.push(p.polygon[a].getLatLngs()[0]);null!==r&&l.push(n);var i=e.denormalize(l);o.$broadcast("ap-map:polygonpicker",t.name,i),null!==r&&r.$setViewValue(i)}},t.clear=s;var g=t.$on("apMap:showOnMapPolygon",function(n,e,o){t.name===e&&null!==o&&d(o)});null!==r&&t.$watch(function(){return r.$modelValue},function(n){n&&angular.isObject(n)&&d(n)}),t.$watch("fixedPolygons",function(n){l(function(){var o,l=e.normalize(n);for(o=0;o<p.fixedPolygons.length;o++)p.fixedPolygons[o].remove();for(p.fixedPolygons=[],o=0;o<l.length;o++)p.fixedPolygons.push(L.polygon(l[o].latLngs,{color:"blue"}).addTo(p.map))})});var f=t.$on("$destroy",function(){null!==p.map&&p.map.off("click",u),g(),f()})},templateUrl:"directives/mapPolygon/mapPolygon.template.html"}}]),angular.module("ap-maps").directive("apMapPolyline",["mapService","$rootScope",function(n,e){return{restrict:"AE",scope:{name:"@"},link:function(o,l,t){var a=l.find(".map");o.height=n.height;var i=null,r=[],p=null;function u(n){if(null!==i){var e=n.latlng,o=L.marker(e);o.addTo(i),o.on("click",c),r.push(o),null===p?p=L.polyline([e],{color:"red"}).addTo(i):p.addLatLng(e)}}function c(n){for(var e=p.getLatLngs(),o=0;o<e.length;o++)if(e[o].equals(n.latlng)){e.splice(o,1);break}this.remove(),p.remove(),p=L.polyline(e,{color:"red"}).addTo(i)}function m(){console.log(r);for(var n=0;n<r.length;n++)r[n].off("click",c),r[n].remove();r=[],null!==p&&(p.remove(),p=null)}n.init(a[0]).then(function(n){(i=n).on("click",u)}),o.finish=function(){if(null!==p){var n=p.getLatLngs();m(),p=L.polyline(n,{color:"red"}).addTo(i),e.$broadcast("ap-map:polylinepicker",o.name,n)}},o.clear=m;var s=o.$on("apMap:showOnMapPolyline",function(n,e,l){o.name===e&&null!==l&&(m(),p=L.polyline(l.latLngs,{color:"red"}).addTo(i))}),d=o.$on("$destroy",function(){null!==i&&i.off("click",u),s(),d()})},templateUrl:"directives/mapPolyline/mapPolyline.template.html"}}]),angular.module("ap-maps").directive("pointPicker",["$rootScope","$timeout",function(n,e){return{require:"ngModel",restrict:"AE",scope:{name:"@"},link:function(o,l,t,a){var i=this;o.model={latitud:null,longitud:null},i.point=null;var r=o.$on("ap-map:pointpicker",function(n,e,l){o.name===e&&a.$setViewValue(l)});o.clickBtn=function(){t.view?(n.$broadcast("apBox:show",t.view),e(function(){n.$broadcast("apMap:showOnMapPoint",o.name,i.point)})):n.$broadcast("apMap:showOnMapPoint",o.name,i.point)},o.$watch(function(){return a.$modelValue},function(n){n&&(i.point=n,o.model.latitud=n.y,o.model.longitud=n.x)});var p=o.$on("$destroy",function(){r(),p()})},templateUrl:"directives/pointPicker/pointPicker.template.html"}}]),angular.module("ap-maps").directive("polygonPicker",["$rootScope","$timeout",function(n,e){return{require:"ngModel",restrict:"AE",scope:{name:"@"},link:function(o,l,t,a){var i=this;i.polygon=null;var r=o.$on("ap-map:polygonpicker",function(n,e,l){o.name===e&&a.$setViewValue(l)});o.clickBtn=function(){t.view?(n.$broadcast("apBox:show",t.view),e(function(){n.$broadcast("apMap:showOnMapPolygon",o.name,i.polygon)})):n.$broadcast("apMap:showOnMapPolygon",o.name,i.polygon)},o.$watch(function(){return a.$modelValue},function(n){n&&(i.polygon=n)});var p=o.$on("$destroy",function(){r(),p()})},templateUrl:"directives/polygonPicker/polygonPicker.template.html"}}]),angular.module("ap-maps").directive("polylinePicker",["linestringNormalizer","$rootScope",function(n,e){return{require:"ngModel",restrict:"AE",scope:{name:"@"},link:function(o,l,t,a){var i=null,r=o.$on("ap-map:polylinepicker",function(e,l,t){if(o.name===l){var i=n.denormalize(t);a.$setViewValue(i)}});o.clickBtn=function(){t.view&&e.$broadcast("apBox:show",t.view),e.$broadcast("apMap:showOnMapPolyline",o.name,i)},o.$watch(function(){return a.$modelValue},function(e){e&&(i=n.normalize(e))});var p=o.$on("$destroy",function(){r(),p()})},templateUrl:"directives/polylinePicker/polylinePicker.template.html"}}]),angular.module("ap-maps").provider("MapsConfig",function(){var n=435,e=[-31.649913,-60.712328],o=13,l="OpenStreetMap.Mapnik";this.setMapHeight=function(e){return n=e,this},this.setCenter=function(n){return e=n,this},this.setZoom=function(n){return o=n,this},this.setTileProvider=function(n){return l=n,this},this.$get=[function(){return{defaultMapHeight:n,defaultCenter:e,defaultZoom:o,defaultTileProvider:l}}]}),angular.module("ap-maps").service("mapService",["MapsConfig","$timeout",function(n,e){return{height:n.defaultMapHeight,init:function(o){return e(function(){var e=L.map(o,{center:n.defaultCenter,zoom:n.defaultZoom},1e3);return L.tileLayer.provider(n.defaultTileProvider).addTo(e),e})}}}]),angular.module("ap-maps").service("linestringNormalizer",["pointNormalizer",function(n){this.normalize=function(e){var o,l,t=[];if(angular.isArray(e))for(o=0;o<e.length;o++)l=e[o],t.push(n.normalize(l));else if(e)for(o=0;o<e.points.length;o++)l=e.points[o],t.push(n.normalize(l));return{latLngs:t,closed:e.closed}},this.denormalize=function(e){for(var o=[],l=0;l<e.length;l++)o.push(n.denormalize(e[l]));return{points:o}}}]),angular.module("ap-maps").service("pointNormalizer",[function(){this.normalize=function(n){return angular.isArray(n)?L.latLng(n[1],n[0]):L.latLng(n.y,n.x)},this.denormalize=function(n){return{x:n.lng,y:n.lat}}}]),angular.module("ap-maps").service("polygonNormalizer",["linestringNormalizer",function(n){this.normalize=function(e){var o,l,t=[];if(angular.isArray(e))for(o=0;o<e.length;o++)l=e[o],t.push(n.normalize(l));else if(e)for(o=0;o<e.rings.length;o++)l=e.rings[o],t.push(n.normalize(l));return t},this.denormalize=function(e){for(var o=[],l=0;l<e.length;l++){var t=e[l],a=n.denormalize(t);o.push(a)}return{rings:o}}}]),angular.module("adminPanel").run(["$templateCache",function(n){n.put("directives/mapPoint/mapPoint.template.html","<div class=map ng-style=\"{'height':height}\"></div>"),n.put("directives/mapPolygon/mapPolygon.template.html","<div class=map ng-style=\"{'height':height}\"></div><button type=button class=button ng-click=clear()>Limpiar</button><button type=button class=button ng-click=finish()>Terminar</button>"),n.put("directives/mapPolyline/mapPolyline.template.html","<div class=map ng-style=\"{'height':height}\"></div><button type=button class=button ng-click=clear()>Limpiar</button><button type=button class=button ng-click=finish()>Terminar</button>"),n.put("directives/pointPicker/pointPicker.template.html",'<div class=row><div class="columns small-12 large-6"><label>Latitud <input type=text ng-value=model.latitud readonly></label></div><div class="columns small-12 large-6"><label>Longitud <input type=text ng-value=model.longitud readonly></label></div><div class="columns small-12 large-6"><button type=button class=button ng-click=clickBtn()>Ver Punto en Mapa</button></div></div>'),n.put("directives/polygonPicker/polygonPicker.template.html",'<div class=row><div class="columns small-12 large-6"><button type=button class=button ng-click=clickBtn()>Ver en Mapa</button></div></div>'),n.put("directives/polylinePicker/polylinePicker.template.html",'<div class=row><div class="columns small-12 large-6"><button type=button class=button ng-click=clickBtn()>Ver en Mapa</button></div></div>')}]);