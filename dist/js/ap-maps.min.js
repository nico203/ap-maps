/*! ap-maps 2017-12-18 */

angular.module("ap-maps",["adminPanel"]),angular.module("ap-maps").directive("apMapPoint",["mapService","$rootScope",function(n,e){return{restrict:"AE",scope:{name:"@"},link:function(t,o,l){function i(n,e){null!==c&&(u.removeLayer(c),c=null),(c=L.marker([n,e])).addTo(u)}function a(n){if(null!==u){var o=n.latlng;i(o.lat,o.lng),e.$broadcast("ap-map:pointpicker",t.name,o)}}var r=o.find(".map");t.height=n.height;var u=null,c=null;n.init(r[0]).then(function(n){(u=n).on("click",a)}),t.$on("apMap:showOnMap",function(n,e,o,l){t.name===e&&null!==o&&null!==l&&i(o,l)});var p=t.$on("$destroy",function(){null!==u&&u.off("click",a),p()})},templateUrl:"directives/mapPoint/mapPoint.template.html"}}]),angular.module("ap-maps").directive("apMapPolygon",["mapService","$rootScope",function(n,e){return{restrict:"AE",scope:{name:"@",type:"@?"},link:function(t,o,l){function i(n){if(null!==c){var e=n.latlng,t=L.marker(e);t.addTo(c),t.on("click",a),p.push(t),null===s?s=L.polyline([e],{color:"red"}).addTo(c):s.addLatLng(e)}}function a(n){for(var e=s.getLatLngs(),t=0;t<e.length;t++)if(e[t].equals(n.latlng)){e.splice(t,1);break}this.remove(),s.remove(),s=L.polyline(e,{color:"red"}).addTo(c)}function r(){console.log(p);for(var n=0;n<p.length;n++)p[n].off("click",a),c.removeLayer(p[n]);p=[],null!==s&&(s.remove(),s=null),null!==m&&(m.remove(),m=null)}var u=o.find(".map");t.height=n.height;var c=null,p=[],s=null,m=null;n.init(u[0]).then(function(n){(c=n).on("click",i)}),t.finish=function(){if(null!==s){var n=s.getLatLngs();r(),"polygon"===t.type?m=L.polygon(n,{color:"red"}).addTo(c):s=L.polyline(n,{color:"red"}).addTo(c),console.log(n),e.$broadcast("ap-map:mappicker",t.name,n)}},t.clear=r;var d=t.$on("apMap:showOnMapPolygon",function(n,e,o){t.name===e&&null!==o&&(r(),"polygon"===t.type?m=L.polygon(o,{color:"red"}).addTo(c):s=L.polyline(o,{color:"red"}).addTo(c))}),g=t.$on("$destroy",function(){null!==c&&c.off("click",i),d(),g()})},templateUrl:"directives/mapPolygon/mapPolygon.template.html"}}]),angular.module("ap-maps").directive("pointPicker",["pointNormalizer","$rootScope",function(n,e){return{require:"ngModel",restrict:"AE",scope:{name:"@"},link:function(t,o,l,i){t.model={latitud:null,longitud:null};var a=t.$on("ap-map:pointpicker",function(e,o,l){if(t.name===o){var a=n.denormalize(l);i.$setViewValue(a)}});t.clickBtn=function(){l.view&&e.$broadcast("apBox:show",l.view),e.$broadcast("apMap:showOnMap",t.name,t.model.latitud,t.model.longitud)},t.$watch(function(){return i.$modelValue},function(e){if(e){console.log("val",e);var o=n.normalize(e);console.log("latLng",o),t.model.latitud=o.lat,t.model.longitud=o.lng}});var r=t.$on("$destroy",function(){a(),r()})},templateUrl:"directives/pointPicker/pointPicker.template.html"}}]),angular.module("ap-maps").directive("polygonPicker",["mapService","$rootScope",function(n,e){return{require:"ngModel",restrict:"AE",scope:{name:"@"},link:function(n,t,o,l){var i=null,a=n.$on("ap-map:mappicker",function(e,t,o){if(n.name===t){for(var i=[],a=0;a<o.length;a++)i.push({latitud:o[a].lat,longitud:o[a].lng});l.$setViewValue(i)}});n.clickBtn=function(){o.view&&e.$broadcast("apBox:show",o.view),e.$broadcast("apMap:showOnMapPolygon",n.name,i)},n.$watch(function(){return l.$modelValue},function(n){n&&(i=n)});var r=n.$on("$destroy",function(){a(),r()})},templateUrl:"directives/polygonPicker/polygonPicker.template.html"}}]),angular.module("ap-maps").provider("MapsConfig",function(){var n=435,e=[-31.649913,-60.712328],t=13,o="OpenStreetMap.Mapnik";this.setMapHeight=function(e){return n=e,this},this.setCenter=function(n){return e=n,this},this.setZoom=function(n){return t=n,this},this.setTileProvider=function(n){return o=n,this},this.$get=[function(){return{defaultMapHeight:n,defaultCenter:e,defaultZoom:t,defaultTileProvider:o}}]}),angular.module("ap-maps").service("mapService",["MapsConfig","$timeout",function(n,e){return{height:n.defaultMapHeight,init:function(t){return e(function(){var e=L.map(t,{center:n.defaultCenter,zoom:n.defaultZoom},1e3);return L.tileLayer.provider(n.defaultTileProvider).addTo(e),e})}}}]),angular.module("ap-maps").service("linestringNormalizer",["pointNormalizer",function(n){this.normalize=function(e){for(var t=[],o=0;o<e.points.length;o++){var l=e.points[o];t.push(n.normalize(l))}return{latLngs:t,closed:e.closed}},this.denormalize=function(e){for(var t=[],o=0;o<e.length;o++)t.push(n.denormalize(e[o]));return{points:t}}}]),angular.module("ap-maps").service("pointNormalizer",[function(){this.normalize=function(n){return console.log("point",n),L.latLng(n.coordinates[0],n.coordinates[1])},this.denormalize=function(n){return{x:n.lat,y:n.lng}}}]),angular.module("ap-maps").service("polygonNormalizer",["linestringNormalizer",function(n){this.normalize=function(e){for(var t=[],o=0;o<e.rings.length;o++){var l=e.rings[o];t.push(n.serialize(l))}return console.log("rings",t),t},this.denormalize=function(n){return n}}]),angular.module("adminPanel").run(["$templateCache",function(n){n.put("directives/mapPoint/mapPoint.template.html","<div class=map ng-style=\"{'height':height}\"></div>"),n.put("directives/mapPolygon/mapPolygon.template.html","<div class=map ng-style=\"{'height':height}\"></div><button type=button class=button ng-click=clear()>Limpiar</button><button type=button class=button ng-click=finish()>Terminar</button>"),n.put("directives/pointPicker/pointPicker.template.html",'<div class=row><div class="columns small-12 large-6"><label>Latitud <input type=text ng-value=model.latitud readonly></label></div><div class="columns small-12 large-6"><label>Longitud <input type=text ng-value=model.longitud readonly></label></div><div class="columns small-12 large-6"><button type=button class=button ng-click=clickBtn()>Ver Punto en Mapa</button></div></div>'),n.put("directives/polygonPicker/polygonPicker.template.html",'<div class=row><div class="columns small-12 large-6"><button type=button class=button ng-click=clickBtn()>Ver en Mapa</button></div></div>')}]);